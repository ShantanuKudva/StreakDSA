// StreakDSA - Prisma Schema
// Generated from PRD.md Data Model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum Topic {
  BASICS
  SORTING
  ARRAYS
  BINARY_SEARCH
  STRINGS
  LINKED_LISTS
  RECURSION
  BIT_MANIPULATION
  STACKS_QUEUES
  SLIDING_WINDOW
  HEAPS
  GREEDY
  BINARY_TREES
  BST
  GRAPHS
  DYNAMIC_PROGRAMMING
  TRIES
  OTHER
}

// =============================================================================
// MODELS
// =============================================================================

/// User account and pledge tracking
model User {
  id             String     @id @default(uuid())
  email          String     @unique
  emailVerified  DateTime?  @map("email_verified")
  name           String?
  image          String?
  
  // Notification Channels
  smsPhone       String?    @map("sms_phone")      /// E.164 format
  whatsappPhone  String?    @map("whatsapp_phone") /// E.164 format
  password       String?    /// Hashed password for credentials login
  
  // Pledge settings (optional until onboarding)
  pledgeDays     Int        @default(0) @map("pledge_days")
  startDate      DateTime?  @map("start_date") @db.Date
  reminderTime   String     @default("22:00") @map("reminder_time") /// HH:mm format
  timezone       String     @default("UTC")
  
  // Custom Settings
  dailyProblemLimit Int     @default(2) @map("daily_problem_limit")
  
  // Notification Preferences
  emailNotifications    Boolean @default(true) @map("email_notifications")
  whatsappNotifications Boolean @default(false) @map("whatsapp_notifications")
  smsNotifications      Boolean @default(false) @map("sms_notifications")
  
  // Streak tracking
  currentStreak  Int        @default(0) @map("current_streak")
  maxStreak      Int        @default(0) @map("max_streak")
  daysCompleted  Int        @default(0) @map("days_completed")
  
  // Gamification
  gems           Int        @default(0)
  
  // Metadata
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  
  // Relations
  accounts       Account[]
  sessions       Session[]
  dailyLogs      DailyLog[]
  
  @@map("users")
}

/// NextAuth Account (OAuth providers)
model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@map("accounts")
}

/// NextAuth Session
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

/// NextAuth Email Verification
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// Daily check-in log
model DailyLog {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  date        DateTime     @db.Date
  completed   Boolean      @default(false)
  isFrozen    Boolean      @default(false) @map("is_frozen")
  markedAt    DateTime?    @map("marked_at") /// When user marked complete
  
  // Metadata
  createdAt   DateTime     @default(now()) @map("created_at")
  
  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  problems    ProblemLog[]
  
  // Constraints: one log per user per day
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("daily_logs")
}

/// Problem solved log (optional, max 2 per day)
model ProblemLog {
  id          String     @id @default(uuid())
  dailyLogId  String     @map("daily_log_id")
  topic       Topic?     // Made optional, transitioning to tags
  tags        String[]   @default([])
  name        String     @db.VarChar(255)
  difficulty  Difficulty
  
  // Optional: LeetCode/external reference (for future integrations)
  externalUrl String?    @map("external_url") @db.VarChar(500)
  
  // Custom user notes/approach
  notes       String?    @db.Text
  
  // Metadata
  createdAt   DateTime   @default(now()) @map("created_at")
  
  // Relations
  dailyLog    DailyLog   @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)
  
  @@index([dailyLogId])
  @@map("problem_logs")
}
